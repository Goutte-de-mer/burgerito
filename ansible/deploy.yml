---
- name: Deploy Burgerito Application
  hosts: all
  become: yes
  vars:
    app_name: burgerito
    app_path: /var/www/{{ app_name }}
    node_version: "20"
    pm2_app_name: "{{ app_name }}"
    project_root: "{{ playbook_dir }}/.."

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install required packages
      apt:
        name:
          - curl
          - git
          - build-essential
          - nginx
        state: present
      when: ansible_os_family == "Debian"

    - name: Install Node.js via NodeSource
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_{{ node_version }}.x | bash -
        apt-get install -y nodejs
      when: ansible_os_family == "Debian"

    - name: Check if PM2 is installed
      command: which pm2
      register: pm2_check
      changed_when: false
      failed_when: false

    - name: Install PM2 globally
      shell: npm install -g pm2 --force
      when: pm2_check.rc != 0

    - name: Create application directory
      file:
        path: "{{ app_path }}"
        state: directory
        owner: "{{ deploy_user | default(ansible_user) | default(ansible_user_id) | default('ubuntu') }}"
        group: "{{ deploy_user | default(ansible_user) | default(ansible_user_id) | default('ubuntu') }}"
        mode: "0755"

    - name: Copy application files
      copy:
        src: "{{ project_root }}/{{ item }}"
        dest: "{{ app_path }}/{{ item }}"
        mode: preserve
      loop:
        - package.json
        - package-lock.json
        - next.config.ts
        - tsconfig.json
      when: item != ".next"

    - name: Copy .next directory
      synchronize:
        src: "{{ project_root }}/.next/"
        dest: "{{ app_path }}/.next/"
        delete: yes
        recursive: yes
        rsync_opts:
          - "--no-perms"
          - "--no-owner"
          - "--no-group"
      delegate_to: localhost
      run_once: true

    - name: Install production dependencies
      npm:
        path: "{{ app_path }}"
        production: yes
        state: present

    - name: Create PM2 ecosystem file
      template:
        src: ecosystem.config.js.j2
        dest: "{{ app_path }}/ecosystem.config.js"
        mode: "0644"

    - name: Start/Restart application with PM2
      shell: |
        cd {{ app_path }}
        /usr/local/bin/pm2 delete {{ pm2_app_name }} || true
        /usr/local/bin/pm2 start ecosystem.config.js
        /usr/local/bin/pm2 save
      environment:
        PATH: "/usr/local/bin:{{ ansible_env.PATH | default('') }}"
        API_URL: "https://node-eemi.vercel.app/api"
        NODE_ENV: "production"
        PORT: "3000"

    - name: Setup PM2 startup script
      shell: /usr/local/bin/pm2 startup systemd -u {{ deploy_user | default(ansible_user) | default(ansible_user_id) | default('ubuntu') }} --hp /home/{{ deploy_user | default(ansible_user) | default(ansible_user_id) | default('ubuntu') }}
      register: pm2_startup
      changed_when: false

    - name: Configure Nginx
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/sites-available/{{ app_name }}
        mode: "0644"
      notify: restart nginx

    - name: Enable Nginx site
      file:
        src: /etc/nginx/sites-available/{{ app_name }}
        dest: /etc/nginx/sites-enabled/{{ app_name }}
        state: link
      notify: restart nginx

    - name: Remove default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx

  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted
        enabled: yes
